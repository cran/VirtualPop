<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Simulation of life histories</title>
<style type="text/css">
/**
 * Prism.s theme ported from highlight.js's xcode style
 */
pre code {
  padding: 1em;
}
.token.comment {
  color: #007400;
}
.token.punctuation {
  color: #999;
}
.token.tag,
.token.selector {
  color: #aa0d91;
}
.token.boolean,
.token.number,
.token.constant,
.token.symbol {
  color: #1c00cf;
}
.token.property,
.token.attr-name,
.token.string,
.token.char,
.token.builtin {
  color: #c41a16;
}
.token.inserted {
  background-color: #ccffd8;
}
.token.deleted {
  background-color: #ffebe9;
}
.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
}
.token.atrule,
.token.attr-value,
.token.keyword {
  color: #836c28;
}
.token.function,
.token.class-name {
  color: #DD4A68;
}
.token.regex,
.token.important,
.token.variable {
  color: #5c2699;
}
.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}
</style>
<style type="text/css">
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  box-sizing: border-box;
}
body, .footnotes, code { font-size: .9em; }
li li { font-size: .95em; }
*, *:before, *:after {
  box-sizing: inherit;
}
pre, img { max-width: 100%; }
pre, pre:hover {
  white-space: pre-wrap;
  word-break: break-all;
}
pre code {
  display: block;
  overflow-x: auto;
}
code { font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace; }
:not(pre) > code, code[class] { background-color: #F8F8F8; }
code.language-undefined, pre > code:not([class]) {
  background-color: inherit;
  border: 1px solid #eee;
}
table {
  margin: auto;
  border-top: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color: #666;
  margin: 0;
  padding-left: 1em;
  border-left: 0.5em solid #eee;
}
hr, .footnotes::before { border: 1px dashed #ddd; }
.frontmatter { text-align: center; }
#TOC .numbered li { list-style: none; }
#TOC .numbered { padding-left: 0; }
#TOC .numbered ul { padding-left: 1em; }
table, .body h2 { border-bottom: 1px solid #666; }
.body .appendix, .appendix ~ h2 { border-bottom-style: dashed; }
.footnote-ref a::before { content: "["; }
.footnote-ref a::after { content: "]"; }
section.footnotes::before {
  content: "";
  display: block;
  max-width: 20em;
}

@media print {
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  tr, img { page-break-inside: avoid; }
}
@media only screen and (min-width: 992px) {
  pre { white-space: pre; }
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
</head>
<body>
<div class="include-before">
</div>
<div class="frontmatter">
<div class="title"><h1>Simulation of life histories</h1></div>
<div class="author"><h2>Frans Willekens</h2></div>
<div class="date"><h3>2024-03-18</h3></div>
</div>
<div class="body">
<h1 id="introduction">Introduction</h1>
<p>The life course or life history is conceptualized as a sequence of states and transitions between states [@willekens2014]. A state is a personal attribute, e.g. marital status or number of children ever born, or a combination of personal attributes. The set of possible states is the state space. It is the set of possible values of a personal attribute or combination of attributes. The individual life history is modelled as a multistate stochastic process. The transitions the individual experiences and the states occupied after the transitions depend on personal characteristics and chance. Transition rates, which are the parameters of the multistate process, are estimated by combining data from different individuals. As a result, the individual life history generated by the model that describes the stochastic process is <em>synthetic</em>. The population is referred to as a virtual population. An individual’s life history depends on several factors, including individual characteristics, social context and personal experiences. In this paper, the influencing factors are limited to personal characteristics, in particular age, sex and parity. The life course is also affected by chance. Individuals with identical characteristics have different life histories due to random factors ^[For a discussion of the distinction between individual heterogeneity and individual stochasticity, see @caswell2009stage.].</p>
<p>The vignette consists of four sections. Section 2 is a brief review of the theory of multistate modelling. For a more extensive discussion, see [@aalen2008survival; @cook2018multistate; and @willekens2014]. Section 3 covers the simulation of a single fertility history. Section 4 is an application. Fertility histories of women in the United States are simulated using data from the Human Fertility Database (HFD) (<a href="http://www.humanfertility.org">www.humanfertility.org</a>) and the Human Mortality Database (HMD) (<a href="http://www.mortality.org">www.mortality.org</a>).</p>
<h1 id="theoretical-background-simulating-life-histories">Theoretical background: simulating life histories</h1>
<p>At any point in time, an individual is in one of r possible states. Let \(_kY(x)\) denote the state individual k occupies at age x. \(_kY(x)\) is a discrete random variable, a Bernoulli random variable if r=2 and a multinomial random variable if r&gt;2. Individual k may leave state i and enter another state j. In some cases, a state can be entered but not left. A state that can be entered and left is a transient state, while a state that can be entered but not left is an absorbing state.</p>
<p>The probability that k is in state i at age x is the <em>state probability</em> \(_kp_i(x)=Pr \left[ _kY(x) = i\right]\), with \(\sum_{i=1}^{r} {_kp_i(x)=1}\). The probability that k is in state i at age x and in state j at age \(x+\tau\) is the joint probability</p>
<p>\begin{equation}
Pr \left[ _kY(x) = i,\text{ } _kY(x+\tau) = j \right]
\end{equation}</p>
<p>The transition probability is the product of the probability that k is in i at x and the conditional probability that k is in j at \(x+\tau\), provided k is in i at x:</p>
<p>\begin{equation}
Pr \left[ _kY (x)=i,_kY(x+\tau)=j \right]  = Pr \left [ _kY(x+\tau)=j |_kY(x)=i \right]  Pr \left[_kY(x)=i \right]
\end{equation}</p>
<p>The conditional probability is the <em>transition probability</em> and is denoted by \(_kp_{j|i}(x,x+\tau)\), which is more conveniently written as \(_kp_{ij}(x,x+\tau)\) and, if \(\tau=1\), it is also written as \(_kp_{ij}(x)\). The probability that k is in j at \(x+\tau\) is the <em>state probability</em></p>
<p>\begin{equation}
<em>kp_j(x+\tau)=\sum</em>{i=1}^{r} {<em>kp</em>{ij}(x,x+\tau)} {_kp_i(x)}
\end{equation}</p>
<p>It expresses the state probability at \(x+\tau\) in terms of the state probabilities at x and the transition probabilities.</p>
<p>State probabilities may be combined in a state vector \(_k\mathbf{S}(x)\) and transition probabilities in the transition matrix \(_k{\mathbf{P}}(x,x+\tau)\):</p>
<p>\begin{equation}
_k{\mathbf{P}}(x,x+\tau)=<br />
\begin{bmatrix}
\text{ }<em>k p</em>{11}(x) &amp; <em>k p</em>{12}(x) &amp; \cdots &amp; <em>k p</em>{1r}(x) \
<em>k p</em>{21}(x) &amp; \text{ }<em>k p</em>{22}(x) &amp; \cdots &amp; <em>k p</em>{2r}(x) \
\vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  \
<em>k p</em>{r1}(x) &amp; <em>k p</em>{r2}(x) &amp; \cdots &amp; \text{ }<em>k p</em>{rr}(x)
\end{bmatrix}
\end{equation}
where \(p_{ii}(\tau)=1 - \sum_{j \ne i}{} _k p_{ij} (\tau)\).</p>
<p>The element \(_k p_{ij} (x,x+\tau)\) denotes the probability that k who occupies stata i at age x occupies state j at age \(x+\tau\). The diagonal element \(_kp_{ii} (x,x+\tau)\) is the probability that k, who is in i at x, is also in i at \(x+\tau\). It does not imply that k remains in i during the entire period from x to \(x+\tau\). Multiple transitions are allowed during the interval \((x,x+\tau)\).</p>
<p>The vector or state probabilities (state vector) at age x is</p>
<p>\begin{equation}
_k\mathbf{S}(x+\tau)=
\begin{bmatrix}
\text{ }<em>k p</em>{1}(x)  \
<em>k p</em>{2}(x) \
\vdots  \
<em>k p</em>{r}(x)
\end{bmatrix}
\end{equation}</p>
<p>The state vector at \(x+\tau\) depends on the state vector at \(x\) and the transition probability matrix:</p>
<p>\begin{equation}
_k\mathbf{S}(x+\tau)=\left[ _k \mathbf{P}(x,x+\tau \right]’ \text{ }_k\mathbf{S}(x)
\end{equation}</p>
<p>where$_k\mathbf{S}(t)$ is a column vector and ’ denotes transpose. This matrix expression is a fundamental equation in multistate modelling. In this vignette, the state equation is specified at the individual level.</p>
<p>If \(\tau\) is small and tends to zero,</p>
<p>\begin{equation}
\frac{1}{\tau} \displaystyle \lim_{\tau \to 0} Pr \left[_kY(x+\tau)=j | _kY(x)=i  \right]= \text{ }<em>k \mu</em>{ij}(x)
\end{equation}</p>
<p>is the instantaneous rate of transition at age x. Multistate models are fully specified by their instantaneous rates of transition. A common assumption in demography is that \(_k \mu_{ij}(x)\) is piecewise constant. They vary between age groups of 1 or 5 years but are constant within age groups.</p>
<p>The instantaneous transition rates are combined in a transition rate matrix:
\begin{equation}
_k\mathbf{\mu}(x)=
\begin{bmatrix}
\text{ }<em>k\mu</em>{11}(x) &amp; -<em>k\mu</em>{12}(x) &amp; \cdots &amp; -<em>k\mu</em>{1r}(x) \
-<em>k\mu</em>{21}(x) &amp; \text{ }<em>k\mu</em>{22}(x) &amp; \cdots &amp; -<em>k\mu</em>{2r}(x) \
\vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  \
-<em>k\mu</em>{r1}(x) &amp; -<em>k\mu</em>{r2}(x) &amp; \cdots &amp; \text{ }<em>k\mu</em>{rr}(x)
\end{bmatrix}
\end{equation}
where \(\mu_{ii}(\tau)=\sum_{j=i}{} _k \mu_{ij} (\tau)\).</p>
<p>The cumulative transition rate during the age interval from 0 to x is the cumulative hazard:
\begin{equation}
<em>k\Lambda</em>{ij}(x)=\int_{0}^{x} {<em>k\mu</em>{ij}(x)}
\end{equation}</p>
<p>The cumulative hazard forms the basis for calculating transition probabilities. The probability that k, who is in i at \(x_1\), is in j at age \(x_2\) is \(exp \left[- _k \Lambda_{ij}(x_1,x_2) \right]\). The probability that k, who is in i at \(x_1\), is still in i at x \((x&gt;x_1)\) is
\begin{equation}
<em>k  S</em>{i+}(x_1,x) =exp \left[-\int_{x_1}^{x} {\sum_{j \ne i} {<em>k \mu</em>{ij}(\tau) d\tau} } \right] = exp\left[-\int_{x_1}^{x} {<em>k \mu</em>{i+}(\tau) d\tau} \right]=exp\left[- <em>k\Lambda</em>{i+}(x_1,x) \right]
\end{equation}</p>
<p>Recall that \(_kY(\tau)=i\) is the probability that k occupies state i at age \(\tau\). It is sometimes convenient to denote the state occupied differently. Let \(_kY_i(\tau)\) be an indicator variable which is one if k is in i at \(\tau\) and zero otherwise:$_kY_i(\tau)=I((_kY(\tau)=i)$. The quantity \(_kY_i(\tau) d\tau\) is the time k spends in i during the interval \((\tau,\tau+d\tau)\). It is also the duration of exposure to the risk (duration at risk) of leaving i.  The total duration of exposure before age x is \(\int_{0}^{x} {_kY_i(\tau) d\tau}\). It is the duration of stay in i between 0 and x. The stay does not need to be on a continuous basis. Individual k may leave i and return to i between ages 0 and x.</p>
<p>The product of the instantaneous transition rate at \(\tau\) and the indicator variable is the <em>transition intensity</em> \(_k\lambda_{ij}(\tau)\):</p>
<p>\begin{equation}
<em>k\lambda</em>{ij}(\tau) = <em>k\mu</em>{ij}(\tau) _kY_i(\tau)
\end{equation}</p>
<p>The function \(_k \mu_{ij}(\tau)\) is the hazard function, \(_kY_i(\tau)\) the exposure function and \(_k\lambda_{ij}(\tau)\) the <em>intensity function</em> [@aalen2008survival,p. 31; @cook2018multistate, p. 29]. The expression \(_k\mu_{ij}(\tau) d \tau\) is the probability that a transition occurs during the interval \((\tau,\tau+d\tau)\), provided k is at risk of experiencing the transition; \(_kY_i(\tau) d\tau\) is the time spent in i during the interval \((\tau,\tau+d\tau)\) (which is the duration of exposure of leaving i); and \(_k\lambda_{ij}(\tau) d\tau\) is the expected number of transitions from i to j by individual k during the interval \((\tau,\tau+d\tau)\). The expected number of transitions between ages 0 and \(x\) is</p>
<p>\begin{equation}
<em>kN</em>{ij}(x)=\int_{0}^{x} {<em>k\lambda</em>{ij}(\tau) d\tau}
\end{equation}</p>
<p>The sequence of random variables \(\{ {_kN_{ij}(\tau); 0 \le \tau \le x}\}\) is a <em>counting process</em> [@aalen2008survival, p. 25]. The presentation of life history processes as counting processes is a logical approach in demography because event occurrences are related to exposures. @willekens2014 adopts the counting process perspective in multistate demographic modelling.</p>
<p>Throughout the interval from 0 to x, individual k may enter any state j from any state i unless \(_k \mu_{ij}(\tau)\)  is zero. To be able to move from i to j during the infinitesimally small interval from \(\tau\) to \(\tau+d\tau\), individual k must be in i at age \(\tau\). The current state occupied determines possible destination states. The state k occupies at \(\tau\) is determined endogenously. As a consequence, the period of exposure is also endogenous starting (and ending) with the occurrence of another transition. For instance, the birth of a first child triggers a period at risk of a birth of a second child. During the interval, k may stop being at risk by moving to another destination or by censoring the observation. In the simulation, the cumulative hazard needs to be computed for a period during which individual k is exposed to the risk of a (i,j)-transition. The exposure function denotes whether an individual of a given age in a given state is at risk of a transition to a given other state. Suppose that between ages \(x_1\) and \(x_2\) (with \(0 \le x_1, x_2 \le x\)) individual k is in state i. The cumulative hazard may be written as</p>
<p>\begin{equation}
<em>k\Lambda</em>{ij}(x_1,x_2)=\int_{x_1}^{x_2} {<em>k\mu</em>{ij}(\tau) d\tau} = \int_{0}^{x} {<em>k\mu</em>{ij}(\tau) <em>kY_i(\tau)} d\tau = \int</em>{0}^{x} {<em>k\lambda</em>{ij}(\tau) d\tau}
\end{equation}</p>
<p>Suppose we know the transition rates and are requested to infer the waiting time to leaving i for individual k, who is in i at \(x_1\). To determine a plausible waiting time, a random number u is drawn from the standard uniform distribution and the root of the equation</p>
<p>\begin{equation}
g(x-x_1)=<em>k \Lambda</em>{i+}(x_1,\infty)+ln(1-u)=0
\end{equation}
is determined. It gives the duration between \(x_1\) and the age at transition, i.e.$x_u-x_1$, with \(x_u\) the age for which the above equation holds.</p>
<p>An individual leaving i moves to a destination state, j say. The destination j is determined by sampling the multinomial distribution with parameters \(\{ _kp_{i1}(x),_kp_{i2}(x), \cdots,_kp_{ir}(x)  \}\)
\begin{equation}
<em>k p</em>{ij}^*(x)=\frac{<em>k\mu</em>{ij}(x)} {\sum_{j \ne i} {<em>k\mu</em>{ij}(x)}  }  \hspace{1.5cm} {j \ne i}
\end{equation}</p>
<p>and \(\sum_{j \ne i} {_k}p_{ij}^*(x)=1\). Sampling a multinomial distribution consists of two steps. First, a random number u is drawn from the standard uniform distribution. Second, the position of u in the parameter space is determined. If \(u &lt; {_kp_{i1}^*(x)}\), the destination is state 1. If \({_kp_{i1}^*(x)} \le u &lt; {_kp_{i2}^*(x)}\), the destination is state 2, etc. The method is equivalent to creating a vector with endpoints 0 and 1 and breakpoints \({_kp_{i1}^*(x)},{_kp_{i1}^*(x)}+{_kp_{i2}^*(x)},{_kp_{i1}^*(x)}+{_kp_{i2}^*(x)}+{_kp_{i3}^*(x)}\), etc. and to determine the segment that contains u.</p>
<p>Some transitions may not be possible, leading to an adjustment of the matrix of instantaneous transition rates \(_k\mathbf{\mu}(x)\). Consider the reproductive process. Each female member of the population becomes at risk of conception at menarche and remains at risk until menopause (conditional on survival and in the absence of sterilization). Fertility rates are zero initially, turn positive during adolescence and become zero again at menopause. The age at birth of the first child is determined by drawing a random waiting time from a piecewise exponential distribution with the age-specific first birth rates as parameters. If the waiting time exceeds the maximum reproductive age, the woman remains childless. Assume singleton births (no twins or triplets). Women with a first child are exposed to the risk of a second child. Exposure starts at the woman’s age at birth of the first child and ends at the age at birth of the second child or the end of the reproductive period, whatever comes first. Women with two children are exposed to the risk of a third child, and so on. Formally, women with i children are at risk of an additional child. The risk period starts at the age of birth of the i-th child and ends at birth of the i+1-st child or the end of the reproductive period (age at menopause). If \(i=0\), exposure starts at the lowest age of the reproductive period (age at menarche). In the reproductive process the transition intensities \(_k\mu_{ij}(\tau)\) are 0 except if j=i+1, with i the current number of biological children ever born to k. The matrix of party-specific instantaneous fertility rates is:
\begin{equation}
_k\mathbf{\mu}(\tau)=
\begin{bmatrix}
\text{ }<em>k\mu</em>{11}(\tau) &amp; -<em>k\mu</em>{12}(\tau) &amp;  0  &amp; \cdots &amp; 0 \
0 &amp; \text{ }<em>k\mu</em>{22}(\tau) &amp; -<em>k\mu</em>{23}(\tau)   &amp; \cdots &amp; 0 \
\vdots  &amp; \vdots  &amp; \vdots &amp; \ddots  &amp; \vdots \
0 &amp; 0 &amp; 0 &amp;  \cdots &amp; \text{ }<em>k\mu</em>{rr}(\tau)
\end{bmatrix}
\end{equation}
with r the highest parity considered in the analysis and the diagonal element \(_k\mu_{rr}(x)\) the instantaneous rate that a woman with r children has another child between \(\tau\) and \(\tau+d\tau\). For instance, if r is five, then a woman with five children may have another child. Beyond parity five, the fertility rate is independent of the parity.  The matrix of transition intensities defines a hierarchical model. A hierarchical model is characterized by having r living states connected by r-1 rates of transition [@schoen2016hierarchical;@schoen2019analytical].</p>
<p>In the presence of mortality, the reproductive life course may be interrupted by death. Birth of the next child and death are competing risks. In the model, it is assumed that the rate of death is independent of the number of children ever born. In that case, individual lifespans may be simulated first, followed by the simulation of fertility careers from birth to death or the end of the reproductive period, whatever comes first.</p>
<h1 id="illustration-simulation-of-a-single-life-history">Illustration: simulation of a single life history</h1>
<p>Two cases are distinguished. In the first, the transition rates do not vary with age. The function sim.msm() of the msm package is used to generate a sequence of transitions. In the second, the transition rates are age-specific. The function Sim_bio() of the VirtualPop package generates the transitions. The life history of an individual is a realization (<em>sample path</em>) of a continuous-time Markov process.</p>
<h2 id="transition-rates-do-not-vary-with-age">Transition rates do not vary with age</h2>
<p>Consider a most simple case. An individual has one attribute with three possible values (A, B and C). The three possible values constitute the state space. The individual moves between the three states at constant rates. The transition rates are:</p>
<pre><code class="language-r">M &lt;- matrix(c(   0.0,0.10,0.05,        
                 0.07,0.0,0.03,
                 0.02,0.05,0.0),nrow=3,byrow=TRUE)
namstates &lt;- c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;)
dimnames(M) &lt;- list(origin=namstates,destination=namstates)
diag(M) &lt;- -rowSums(M)
MM &lt;- -M
out &lt;- knitr::kable(MM,
  caption = &quot;Transition rate matrix&quot;,
  format = 'latex', booktabs = T,linesep = &quot;&quot;)
y &lt;- kableExtra::kable_styling(out,latex_options=&quot;HOLD_position&quot;)
kableExtra::add_header_above(y,c(&quot;From&quot;=1,
                          &quot;To&quot;=3))
</code></pre>
<p>\begin{table}[H]</p>
<p>\caption{\label{tab:unnamed-chunk-1}Transition rate matrix}
\centering
\begin{tabular}[t]{lrrr}
\toprule
\multicolumn{1}{c}{From} &amp; \multicolumn{3}{c}{To} \
\cmidrule(l{3pt}r{3pt}){1-1} \cmidrule(l{3pt}r{3pt}){2-4}
&amp; A &amp; B &amp; C\
\midrule
A &amp; 0.15 &amp; -0.10 &amp; -0.05\
B &amp; -0.07 &amp; 0.10 &amp; -0.03\
C &amp; -0.02 &amp; -0.05 &amp; 0.07\
\bottomrule
\end{tabular}
\end{table}</p>
<p>The transition rate matrix MM has the format of the matrix in equation 5.</p>
<p>The constant transition rates are used to generate life histories during segments of life. The function sim.msm() of the msm package simulates one realisation from a continuous-time Markov process up to a given time. Note that sim.msm() requires that the states are numeric values. The function also requires that the transition matrix has origin in rows and destination in columns [@jackson2011multi, p. 6].  The following code chunk generates a history between ages 20 and 40 for an individual who starts in state A at age 20.</p>
<pre><code class="language-r">set.seed(33)
bio &lt;- msm::sim.msm (qmatrix=-MM,mintime=20,maxtime=40,start=1)
bio
$states
[1] 1 3 2 2

$times
[1] 20.00000 26.44465 36.26984 40.00000

$qmatrix
      destination
origin     A     B     C
     A -0.15  0.10  0.05
     B  0.07 -0.10  0.03
     C  0.02  0.05 -0.07
</code></pre>
<p>The function produces a list of three objects:</p>
<ul>
<li>Sequence of states occupied. The first state is the state at the start of the simulation. The last state is the state occupied at the end of the simulation, which is the same as the state occupied after the last transition.</li>
<li>Ages of transition. The list includes the starting age and ending age.</li>
<li>The transition matrix used to generate the life histories</li>
</ul>
<p>At the start of the simulation, the individual is in state A (state 1) and exposed to the risk of moving to state B (state 2) or C (state 3). A random draw from the exponential waiting time distribution gives 6.44 years (since the start of the simulation and 26.44 years since the start of the time scale). Since 6.44 is the duration at which the value of the cumulative probability distribution is equal to u, we may determine the value of u produced by the random draw:</p>
<p>The probability that an individual in state A at age 20 leaves A before the end of the observation at 40 is \(1-exp\left [-0.15*20\right]=0.95\). Hence, if a random number is drawn that exceeds 0.95, the waiting time to the transition exceeds the observation window. In that case, the transition does not occur due to censoring at age 40.</p>
<p>The destination state is determined by a Bernoulli trial with two possible outcomes (B and C) and the probability \(0.10/(0.10+0.05)=0.667\) that B is the outcome.</p>
<p>The function sim.msm() is also used by @cook2018multistate[p.339].</p>
<h2 id="transition-rates-are-age-specific">Transition rates are age-specific</h2>
<p>After this illustration of the mechanism, we return to fertility. Suppose a female member of the virtual population experiences throughout her life the age- and parity-specific fertility rates of the United States in 2021. The function Sim_bio() of VirtualPop is used to generate the fertility career. Unlike in sim.msm(), the transition rates used by Sim_bio() are age-specific. The fertility rates of the United States in 2021 are distributed with the \(VirtualPop\) package. They are loaded with the \(data\) function of R base:</p>
<pre><code class="language-r">rates &lt;- NULL
data(rates,package=&quot;VirtualPop&quot;)
</code></pre>
<p>The object \(rates\) has three components: (a) the death rates by age and sex (ASDR), (b) the fertility rates by age and parity (ASFR), and © the fertility rates in a format required by multistate models (ratesM). The rates for ages 25 to 29 are:</p>
<pre><code class="language-r">rates$ratesM[26:29,,]
, , Origin = par0

    Destination
Age     par0     par1 par2 par3 par4 par5 par6
  25 0.05096 -0.05096    0    0    0    0    0
  26 0.05541 -0.05541    0    0    0    0    0
  27 0.06092 -0.06092    0    0    0    0    0
  28 0.06700 -0.06700    0    0    0    0    0

, , Origin = par1

    Destination
Age  par0    par1     par2 par3 par4 par5 par6
  25    0 0.16837 -0.16837    0    0    0    0
  26    0 0.16459 -0.16459    0    0    0    0
  27    0 0.16296 -0.16296    0    0    0    0
  28    0 0.15846 -0.15846    0    0    0    0

, , Origin = par2

    Destination
Age  par0 par1    par2     par3 par4 par5 par6
  25    0    0 0.14037 -0.14037    0    0    0
  26    0    0 0.13269 -0.13269    0    0    0
  27    0    0 0.12488 -0.12488    0    0    0
  28    0    0 0.11813 -0.11813    0    0    0

, , Origin = par3

    Destination
Age  par0 par1 par2    par3     par4 par5 par6
  25    0    0    0 0.13098 -0.13098    0    0
  26    0    0    0 0.12428 -0.12428    0    0
  27    0    0    0 0.11592 -0.11592    0    0
  28    0    0    0 0.10721 -0.10721    0    0

, , Origin = par4

    Destination
Age  par0 par1 par2 par3    par4     par5 par6
  25    0    0    0    0 0.14481 -0.14481    0
  26    0    0    0    0 0.13719 -0.13719    0
  27    0    0    0    0 0.12908 -0.12908    0
  28    0    0    0    0 0.12046 -0.12046    0

, , Origin = par5

    Destination
Age  par0 par1 par2 par3 par4    par5     par6
  25    0    0    0    0    0 0.14481 -0.14481
  26    0    0    0    0    0 0.13719 -0.13719
  27    0    0    0    0    0 0.12908 -0.12908
  28    0    0    0    0    0 0.12046 -0.12046

, , Origin = par6

    Destination
Age  par0 par1 par2 par3 par4 par5 par6
  25    0    0    0    0    0    0    0
  26    0    0    0    0    0    0    0
  27    0    0    0    0    0    0    0
  28    0    0    0    0    0    0    0
</code></pre>
<p>The following function call simulates the fertility career of a hypothetical person born on June 12th 1990.</p>
<pre><code class="language-r">popsim &lt;- data.frame (ID=3,
           born=1990.445,
           start=0,
           end=55,
           st_start=&quot;par0&quot;)
set.seed(31)
ch &lt;- suppressWarnings(VirtualPop::Sim_bio (datsim=popsim,
                                            ratesM=rates$ratesM))
ch
$age_startSim
[1] 0

$age_endSim
[1] 56

$nstates
[1] 6

$states
[1] 1 2 3 4 5 6

$path
[1] &quot;par0par1par2par3par4par5&quot;

$ages_trans
[1] 19.36979 25.50009 31.11729 33.41448 38.56408
</code></pre>
<p>The individual has 5 children. The first child is born at age 19.37 and the second at age 25.5. Since the date of birth is known, the calendar dates at childbirth can be determined. The first child is born on Sun Oct 25 2009:</p>
<pre><code class="language-r">z &lt;- format(lubridate::date_decimal(1990.445+ch$ages_trans[1]),  
                      &quot;%a %b %d %Y&quot; )
</code></pre>
<p>The simulation window covers the entire reproductive period. The simulation may be interrupted at any age during the reproductive period, analogous to the censoring of a longitudinal observation. The argument \(end\) of the Sim_bio() function is an individual-level variable indicating the end of the simulation for the individual. In the presence of mortality, \(end\) is the age at death. The individual fertility career is simulated until \(end\) is reached. Sim_bio() is used in the function Children() of VirtualPop, used in the next section.</p>
<h1 id="application-fertility-histories-of-women-in-the-united-states">Application: fertility histories of women in the United States</h1>
<p>The model described in the previous section is used to simulate individual fertility histories in the presence of mortality.The data are mortality rates of the United States in 2021, by age and sex and fertility rates by age and parity. The rates are included in the VirtualPop package for illustrative purpose. They are retrieved using the code</p>
<pre><code class="language-r">rates &lt;- NULL
data(rates,package=&quot;VirtualPop&quot;)
</code></pre>
<p>The creation of a virtual population involves several steps. The remainder of this section is a description of the steps to generate the virtual population. The steps are:</p>
<ul>
<li>Decide on the size of the virtual population</li>
<li>Create a data frame with selected data on each individual in the virtual population.
<ul>
<li>Add ID of partner (function PartnerSearch())</li>
</ul>
</li>
<li>Generate fertility histories for members of initial population - generation 1 (function Children())</li>
<li>Add, for each new-born, date of birth, sex, ID of mother and ID father</li>
<li>Add, for each person, ID of partner</li>
<li>Generate individual fertility histories for members of generation 2 (function Children())</li>
<li>Generate individual fertility histories for members of generation 3 and higher (function Children())</li>
</ul>
<p>The simulation starts by determining the size of the virtual population. Each individual in the virtual population is assigned a unique identification number (ID) and a date of birth. If all births occur in the same year or same period, then the population consists of a single birth cohort. In this section, it is assumed that all births occur in a single year. Dates of birth are obtained by sampling from a probability distribution of births during the year. In this paper, a uniform distribution is assumed (no seasonal effects). The date of birth of an individual is the year of birth plus a fraction of a year, equal to a random number from the standard uniform distribution. The date of birth is expressed as a real number and is referred to as <em>decimal date of birth</em>. The format is particularly useful to compute ages and durations. Note that the computer does not store calendar dates, but stores dates as time (seconds or milliseconds) elapsed since a reference date and time, e.g. midnight, 1st January 1970.</p>
<p>At the start of the simulation, each individual is randomly assigned a sex using the empirical sex ratio at birth. Other personal attributes may be added, but they are omitted in this illustration.</p>
<p>The simulation includes a very simple partner formation process. Partners are selected at random from the opposite sex. Since the process is purely random, union formation may be simulated to occur at birth. When more boys are born than girls, some males remain without a partner.</p>
<p>For each individual in the virtual population, a data record is created. It contains the individual’s ID, date of birth and sex. It also contains a variable for the generation to which the individual belongs. The code is</p>
<pre><code class="language-r">cohort &lt;- 2021
ncohort &lt;- 1000
ID &lt;- 1:ncohort
sex &lt;- rbinom(ncohort,1,prob=1/2.05)
sex &lt;- factor (sex,levels=c(0,1),labels=c(&quot;Male&quot;,&quot;Female&quot;),ordered=TRUE)
# Population size by sex
nmales &lt;- length(sex[sex==&quot;Male&quot;])
nfemales &lt;- length(sex[sex==&quot;Female&quot;])
gen &lt;- rep(1,ncohort) # generation 1
# Decimal date of birth
bdated &lt;- cohort+runif(ncohort)
# Create data frame
d &lt;- data.frame (ID=ID,
                 gen=gen,
                 cohort=cohort,
                 sex=sex,
                 bdated=bdated,
                 ddated=NA,
                 x_D=NA,
                 IDmother=NA,
                 IDfather=NA,
                 jch=NA,
                 IDpartner=NA,
                 udates=NA,
                 nch=NA)
# Ages at death, obtained by sampling a peicewise-exponential distribution, 
# using the rpexp function of the msm package
ages &lt;- as.numeric(rownames(rates$ASDR))
d$x_D[d$sex==&quot;Male&quot;] &lt;- msm::rpexp(n=nmales,rate=rates$ASDR[,&quot;Males&quot;],
                                   t=ages)
d$x_D[d$sex==&quot;Female&quot;] &lt;- msm::rpexp(n=nfemales,rate=rates$ASDR[,&quot;Females&quot;],
                                     t=ages)
# Decimal data of death
d$ddated &lt;- d$bdated+d$x_D
</code></pre>
<p>Individual records include empty spaces for the ID an individual’s partner, mother and father. Their IDs are determined later. The spaces are included to facilitate the merging of data on multiple generations into a single data frame.</p>
<p>The simple PartnerSearch model is implemented in function PartnerSearch(). It accepts the data frame \(d\) as input and returns d augmented by the partner’s ID.</p>
<pre><code class="language-r">d &lt;- VirtualPop::PartnerSearch(dLH=d)
</code></pre>
<p>The first lines of the data frame of individual records are:</p>
<pre><code class="language-r">out &lt;- knitr::kable(head(d),
  caption = &quot;Data for selected individuals&quot;,
  format = 'latex', booktabs = T,linesep = &quot;&quot;)
kableExtra::kable_styling(out,latex_options=c(&quot;scale_down&quot;, &quot;HOLD_position&quot;))
</code></pre>
<p>\begin{table}[H]</p>
<p>\caption{\label{tab:unnamed-chunk-10}Data for selected individuals}
\centering
\resizebox{\linewidth}{!}{
\begin{tabular}[t]{rrrlrrrlllrll}
\toprule
ID &amp; gen &amp; cohort &amp; sex &amp; bdated &amp; ddated &amp; x_D &amp; IDmother &amp; IDfather &amp; jch &amp; IDpartner &amp; udates &amp; nch\
\midrule
1 &amp; 1 &amp; 2021 &amp; Male &amp; 2021.033 &amp; 2094.614 &amp; 73.58084 &amp; NA &amp; NA &amp; NA &amp; 122 &amp; NA &amp; NA\
2 &amp; 1 &amp; 2021 &amp; Male &amp; 2021.041 &amp; 2108.618 &amp; 87.57696 &amp; NA &amp; NA &amp; NA &amp; 786 &amp; NA &amp; NA\
3 &amp; 1 &amp; 2021 &amp; Male &amp; 2021.181 &amp; 2089.131 &amp; 67.95004 &amp; NA &amp; NA &amp; NA &amp; 999 &amp; NA &amp; NA\
4 &amp; 1 &amp; 2021 &amp; Male &amp; 2021.857 &amp; 2099.140 &amp; 77.28293 &amp; NA &amp; NA &amp; NA &amp; 68 &amp; NA &amp; NA\
5 &amp; 1 &amp; 2021 &amp; Male &amp; 2021.081 &amp; 2111.526 &amp; 90.44429 &amp; NA &amp; NA &amp; NA &amp; 548 &amp; NA &amp; NA\
6 &amp; 1 &amp; 2021 &amp; Male &amp; 2021.645 &amp; 2110.168 &amp; 88.52360 &amp; NA &amp; NA &amp; NA &amp; 852 &amp; NA &amp; NA\
\bottomrule
\end{tabular}}
\end{table}</p>
<p>For women, ages at childbirth are determined by sampling from waiting time distributions with parameters equal to the fertility rates by age and parity. When a child is born, it receives a unique ID and a new individual data record is created. The children of the initial cohort constitute generation 2. The date of birth of a child is determined by the date of birth of the mother and her exact age at birth of the child. The ID of the mother is added to the child’s record and the child’s ID is added to the data record of the mother. The record linkages enable to track the descending line of offspring and ascending line of parentage. It significantly facilitates the study of genealogies and kinship networks. The new-born is also assigned a sex using the empirical sex ratio at birth. A partner is allocated by randomly drawing an ID of members of the same generation but of opposite sex. The lifespan and the fertility career of each member of the second generation is determined by sampling the appropriate probability distributions. The function \(Children()\) does the computations. The first argument is the individual data structure,$d$ in this illustration, and the second is the object with the transition rates. For instance,</p>
<pre><code class="language-r">dch1 &lt;- VirtualPop::Children(dat0=d,rates=rates)
</code></pre>
<p>The object \(dch1\) has two components: \(data\) and \(dch\). The first components is comparable to the women’s file in demographic surveys and the second to the children’s file (see e.g. Demographic and Health Survey (DHS) [https://dhsprogram.com]). The object \(data\) is the input object \(d\) with, for each mother and father, information on number of children.</p>
<p>The second object \(dch\) is a data frame with individual records for the new-borns (second generation). It has the ID of the child, the generation, sex, date of birth, the birth order (variable \(jch\)), the ID of the mother, the ID of the father, and the date of death of the child. The ID of the father is the ID of the partner of the mother:</p>
<pre><code class="language-r">dch1$dch$IDfather &lt;- dch1$data$IDpartner[dch1$dch$IDmother]
</code></pre>
<p>The first records are shown below.</p>
<pre><code class="language-r">out &lt;- knitr::kable(head(dch1$dch),
  caption = &quot;Data for selected children of members of initial cohort&quot;,
  format = 'latex', booktabs = T,linesep = &quot;&quot;)
kableExtra::kable_styling(out,latex_options=c(&quot;scale_down&quot;,&quot;HOLD_position&quot;))
</code></pre>
<p>\begin{table}[H]</p>
<p>\caption{\label{tab:unnamed-chunk-13}Data for selected children of members of initial cohort}
\centering
\resizebox{\linewidth}{!}{
\begin{tabular}[t]{rrrlrrrrrrlll}
\toprule
ID &amp; gen &amp; cohort &amp; sex &amp; bdated &amp; ddated &amp; x_D &amp; IDmother &amp; IDfather &amp; jch &amp; IDpartner &amp; udates &amp; nch\
\midrule
1001 &amp; 2 &amp; 2021 &amp; Male &amp; 2046.150 &amp; 2128.191 &amp; 82.04110 &amp; 7 &amp; 229 &amp; 1 &amp; NA &amp; NA &amp; NA\
1002 &amp; 2 &amp; 2021 &amp; Female &amp; 2046.193 &amp; 2124.670 &amp; 78.47655 &amp; 7 &amp; 229 &amp; 2 &amp; NA &amp; NA &amp; NA\
1003 &amp; 2 &amp; 2021 &amp; Male &amp; 2056.244 &amp; 2122.886 &amp; 66.64204 &amp; 7 &amp; 229 &amp; 3 &amp; NA &amp; NA &amp; NA\
1004 &amp; 2 &amp; 2021 &amp; Male &amp; 2060.358 &amp; 2108.437 &amp; 48.07914 &amp; 10 &amp; 501 &amp; 1 &amp; NA &amp; NA &amp; NA\
1005 &amp; 2 &amp; 2021 &amp; Female &amp; 2046.527 &amp; 2116.963 &amp; 70.43553 &amp; 13 &amp; 232 &amp; 1 &amp; NA &amp; NA &amp; NA\
1006 &amp; 2 &amp; 2021 &amp; Male &amp; 2055.651 &amp; 2156.033 &amp; 100.38134 &amp; 13 &amp; 232 &amp; 2 &amp; NA &amp; NA &amp; NA\
\bottomrule
\end{tabular}}
\end{table}</p>
<p>The members of the second generation partner with individuals of the same generation. Partners are allocated randomly.</p>
<pre><code class="language-r">d2 &lt;- VirtualPop::PartnerSearch (dLH=dch1$dch)
</code></pre>
<p>The object \(d2\) is \(dch1\\)dch$ augmented by the IDs of partners. The data frame contains the data on the second generation in a format that is consistent with the data frame of the first generation, which facilitates merging the data frames. The Children() function is used repeatedly to obtain data on the third and higher generations:</p>
<pre><code class="language-r">dch2 &lt;-  VirtualPop::Children(dat0=d2,rates=rates)
</code></pre>
<p>PartnerSearch in the third generation is the outcome of a random search:</p>
<pre><code class="language-r">d3 &lt;- VirtualPop::PartnerSearch (dLH=dch2$dch)
dch3 &lt;-  VirtualPop::Children(dat0=d3,rates=rates)
d4 &lt;- VirtualPop::PartnerSearch (dLH=dch3$dch)
dch4 &lt;-  VirtualPop::Children(dat0=d4,rates=rates)
d4 &lt;- dch4$data[,1:which (colnames(dch4$data)==&quot;nch&quot;)]
</code></pre>
<p>The object \(d4\) has data on the fourth generation, including on the children of members of the fourth generation.</p>
<p>Data on the four generations are merged to a single data frame.</p>
<pre><code class="language-r">dLH2 &lt;- rbind(dch1$data,dch2$data,dch3$data,dch4$data)
</code></pre>
<p>The data frame that results is similar to the \(dLH\) data object included in the VirtualPop package.</p>
<h1 id="references">References{-}</h1>
</div>
<div class="include-after">
</div>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/combine/npm/katex/dist/katex.min.js,npm/katex/dist/contrib/auto-render.min.js,npm/@xiee/utils/js/render-katex.js" defer></script>
</body>
</html>
